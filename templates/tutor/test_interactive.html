
{% load i18n staticfiles %}

<!DOCTYPE html>
<html>
<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script src="{% static 'javascript/csound.js' %}"></script>
    <script src="{% static 'javascript/wavesurfer.min.js' %}"></script>
</head>

<body>
<script src="{% static 'javascript/interactive_csound.js' %}"></script>

<p>Test name: {{ context.test_name }}</p>
<p>FX set: {{ context.effect_set }}</p>
<p>csd file: {{ context.csd }}</p>

<p>Input level: <input class="slider" id="input_level" type="range" min=0.0 max=1.0 value=1.0 step="0.01"/><label id="input_level_label">1</label></p>

<script type="text/javascript">

	{% for effect_name, effect_parameter_set in context.effect_set.items %}
		{% for parameter, values in effect_parameter_set.items %}
			
			// Get max/min and the function curve type: lin, expon or log.
			var minValue = {{ values.1.0 }};
			var maxValue = {{ values.1.1 }};

			// Get correct average value based on curve function
			var curveType = "{{ values.2 }}";
			var averageValue = getValueFromCurve(((minValue + maxValue) / 2), minValue, maxValue, curveType);

			console.log(averageValue);

			document.write("<p>{{ parameter }}:\
				<input\
				class = \"slider\"\
				id = \"{{ effect_name }}_{{ parameter }}\"\
				type = \"range\"\
				min = " + minValue + "\
				max = " + maxValue + "\
				value = " + averageValue + "\
				step = \"0.01\"\
				disabled/>\
				<label id = \"{{ effect_name }}_{{ parameter }}_label\"\
				value = " + averageValue + ">\
				</p>");

		{% endfor %}
	{% endfor %}

    function moduleDidLoad() {
		localStorage.clear();

		// Add waveform
		wavesurfer.init({
			container: document.querySelector('#waveform'),
			progressColor: '#00b2a9',
			waveColor: '#68D8D6',
			cursorWidth: '0',
			pixelRatio: '2',
			interact: false
		});
		wavesurfer.load("/site_media/system/samples/{{ context.sound }}");
		wavesurfer.toggleMute();

		// Load initial csd file
		var csd_url = "/site_media/user/{{ context.csd }}";
		var csd_name = "test.csd";
		csound.CopyUrlToLocal(csd_url, csd_name);

		// Load initial audio file. TODO: Be able to change audio file
		loadAudio("/site_media/system/samples/{{ context.sound }}");

		// Start csound
		setTimeout(function() {
			csound.PlayCsd("local/test.csd");
		}, 500);

		// Set levels to hear only the target sound
		csound.SetChannel("target_amplitude", 1.0);
		csound.SetChannel("user_amplitude", 0.0);
		csound.SetChannel("input_level", 1.0);

		// Add input level slider listener
		$("#input_level").on("input change", function() {
			var value = document.getElementById("input_level").value;
			csound.SetChannel("input_level", value);
			$("#input_level_label").text(value);
		});

		// Add sliders for csound communication
		{% for effect_name, effect_parameter_set in context.effect_set.items %}
			{% for parameter, values in effect_parameter_set.items %}

				// Get max/min and the function curve type: lin, expon or log.
				var minValue = {{ values.1.0 }};
				var maxValue = {{ values.1.1 }};

				// Get average value based on function slope
				var curveType = "{{ values.2 }}";
				var averageValue = getValueFromCurve(((minValue + maxValue) / 2), minValue, maxValue, curveType);

				csound.SetChannel("{{ effect_name }}_{{ parameter }}", averageValue);

				// Add listeners
				$("#{{ effect_name }}_{{ parameter }}").on("input change", function() {
					var minValue = {{ values.1.0 }};
					var maxValue = {{ values.1.1 }};
					var curveType = "{{ values.2 }}"; // lin, exp or log
					var dataType = "{{ values.3 }}"; // float or int

					var value = document.getElementById("{{ effect_name }}_{{ parameter }}").value;
					var scaledValue = getValueFromCurve(value, minValue, maxValue, curveType);
					csound.SetChannel("{{ effect_name }}_{{ parameter }}", scaledValue);
					$("#{{ effect_name }}_{{ parameter }}_label").text(scaledValue);

					if (dataType == 'int') {
						document.getElementById("{{ effect_name }}_{{ parameter }}").step = 1;
					}
			    });
			{% endfor %}
		{% endfor %}
	}

	function mute() {
		if(!userInstanceIsPlaying) {
			csound.SetChannel("target_amplitude", 0.0);
			csound.SetChannel("user_amplitude", 1.0);
		} else {
			csound.SetChannel("target_amplitude", 1.0);
			csound.SetChannel("user_amplitude", 0.0);
		}
		userInstanceIsPlaying = !userInstanceIsPlaying;
		
		// Disable all sliders if not interactable
		{% for effect_name, effect_parameter_set in context.effect_set.items %}
			{% for parameter, values in effect_parameter_set.items %}
				document.getElementById("{{ effect_name }}_{{ parameter }}").disabled = !document.getElementById("{{ effect_name }}_{{ parameter }}").disabled;
			{% endfor %}
		{% endfor %}
	}
</script>

<input type="image" id="playPauseButton" src="{% static 'images/play.png' %}" style="outline: none;" />
<input type="button" id="switchInstanceButton" value="A/B">

<form class="test-form-wrapper" action="/tutor/test_interactive/{{ context.test_name }}/{{ context.level }}/{{ context.FX }}" method="post">
	{% csrf_token %}
	<input type="submit" value="Submit" />
</form>

<!-- waveform -->
<div id="waveform">
    <div class="progress progress-striped active" id="progress-bar">
        <div class="progress-bar progress-bar-info"></div>
    </div>
</div>

<!-- csound message field -->
<div id="csound_message"> </div>

<!--pNaCl csound module -->
<div id="engine"></div>

</body>
</html>