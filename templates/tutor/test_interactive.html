
{% load i18n staticfiles %}

<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="/static/css/application.css">
    <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'> <!-- LAGT TIL -->

	<style>
		.knobjs-bg {
			fill: rgba(0,0,0,0);
		}

		.knobjs-arcbg {
			fill: rgba(0,0,0,0); 
			stroke-width: 0.05; 
			stroke: #BBB;
		}

		.knobjs-arc {
			fill: #BBB;
		}

		x-knobjs-knob {
			display: inline-block;
			height: 90px;
		}

		.knob {
			display: inline-block;
			width: 90px;
			text-align: center;
			padding-right: 25px;
		}

		.knob_value {
			position: relative;
			top: -64px;
			pointer-events: none;
			text-transform: uppercase;
			font-family: 'Montserrat', sans-serif;
			color: #BBB;
		}

		.knob_label {
			position: relative;
			top: -40px;
			pointer-events: none;
			font-family: 'Montserrat', sans-serif;
			color: #333;
		}

		h2 {
			font-family: 'Montserrat';
			color: #333;
			text-transform: uppercase;
		}

	</style>
	<script src="http://www.russellmcc.com/knobjs/knob.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script src="{% static 'javascript/csound.js' %}"></script>
    <script src="{% static 'javascript/wavesurfer.min.js' %}"></script>
</head>

<body>
<script src="{% static 'javascript/interactive_csound.js' %}"></script>

<!-- waveform -->
<div id="waveform">
    <div class="progress progress-striped active" id="progress-bar">
        <div class="progress-bar progress-bar-info"></div>
    </div>
</div>

<!-- <p>Test name: {{ context.test_name }}</p>
<p>FX set: {{ context.effect_set }}</p>
<p>FX values: {{ context.effect_values }}</p>
<p>csd file: {{ context.csd }}</p> -->

<p>Input level: <input class="slider" id="input_level" type="range" min=0.0 max=1.0 value=1.0 step="0.01"/><label id="input_level_label">1</label></p>

<script type="text/javascript">

	$(document).on('touchmove', function(e) {
	    if (!$(e.target).parents('.scroll')[0]) {
	        e.preventDefault();
	    }
	});

	// Cancel dragging if mouse leaves the editor container.
    $('.testElement').on('mouseleave', function(){
    	var event = document.createEvent('MouseEvents');
    	event.initEvent('blur', true, true);
    	document.dispatchEvent(event);
    });

	// Set up sliders
	{% for effect_name, effect_parameter_set in context.effect_set.items %}
		document.write("<div class=\"effect\">");
		document.write("<h2>{{ effect_name }}<h2>");
		{% for parameter, values in effect_parameter_set.items %}

			// Get max/min and the function curve type: lin, expon or log.
			var minValue = {{ values.0.0 }};
			var maxValue = {{ values.0.1 }};

			// Get correct average value based on curve function
			var curveType = "{{ values.1 }}";
			var averageValue = getValueFromCurve(((minValue + maxValue) / 2), minValue, maxValue, curveType);

			// document.write("<p>{{ values.3 }}:\
			// 	<input\
			// 	class = \"slider\"\
			// 	id = \"{{ effect_name }}_{{ parameter }}\"\
			// 	type = \"range\"\
			// 	min = " + minValue + "\
			// 	max = " + maxValue + "\
			// 	value = " + averageValue + "\
			// 	step = \"0.01\"\
			// 	disabled/>\
			// 	<label id = \"{{ effect_name }}_{{ parameter }}_label\"\
			// 	value = " + averageValue + ">\
			// 	</p>");

			document.write("<div class=\"knob\">\
				<x-knobjs-knob id=\"{{ effect_name }}_{{ parameter }}\"></x-knobjs-knob>\
				<label class=\"knob_value\" id = \"{{ effect_name }}_{{ parameter }}_label\">123</label>\
				<h2 class=\"knob_label\" id=\"{{ effect_name }}_{{ parameter }}\">{{ parameter }}</h2></div>");
			document.getElementById("{{ effect_name }}_{{ parameter }}").setAttribute("max", maxValue);
			document.getElementById("{{ effect_name }}_{{ parameter }}").setAttribute("min", minValue);
			document.getElementById("{{ effect_name }}_{{ parameter }}").setAttribute("value", averageValue);
		{% endfor %}
		document.write("</div>");
	{% endfor %}

    function moduleDidLoad() {
		localStorage.clear();

		// Add waveform
		wavesurfer.init({
			container: document.querySelector('#waveform'),
			progressColor: '#00B2A9',
			waveColor: '#68D8D6',
			cursorWidth: '0',
			pixelRatio: '2',
			interact: false
		});
		wavesurfer.load("/site_media/system/samples/{{ context.sound }}");
		wavesurfer.toggleMute();

		// Load initial csd file
		var csd_url = "/site_media/user/{{ context.csd }}";
		var csd_name = "test.csd";
		csound.CopyUrlToLocal(csd_url, csd_name);

		// Load initial audio file. TODO: Be able to change audio file
		loadAudio("/site_media/system/samples/{{ context.sound }}");

		// Start csound
		setTimeout(function() {
			csound.PlayCsd("local/test.csd");
		}, 500);

		// Set levels to hear only the target sound
		csound.SetChannel("target_amplitude", 1.0);
		csound.SetChannel("user_amplitude", 0.0);
		csound.SetChannel("input_level", 1.0);

		// Add input level slider listener
		$("#input_level").on("input change", function() {
			var value = document.getElementById("input_level").value;
			csound.SetChannel("input_level", value);
			$("#input_level_label").text(value);
		});

		// Add sliders for csound communication
		{% for effect_name, effect_parameter_set in context.effect_set.items %}
			{% for parameter, values in effect_parameter_set.items %}

				// Get max/min and the function curve type [lin, expon, log]
				var minValue = {{ values.0.0 }};
				var maxValue = {{ values.0.1 }};

				// Get average value based on function slope
				var curveType = "{{ values.1 }}";
				var averageValue = getValueFromCurve(((minValue + maxValue) / 2), minValue, maxValue, curveType);

				csound.SetChannel("{{ effect_name }}_{{ parameter }}", averageValue);

				// Add listeners
				$("#{{ effect_name }}_{{ parameter }}").on("input change", function() {
					var minValue = {{ values.0.0 }};
					var maxValue = {{ values.0.1 }};
					var curveType = "{{ values.1 }}"; // lin, exp or log
					var dataType = "{{ values.2 }}"; // float or int

					var value = document.getElementById("{{ effect_name }}_{{ parameter }}").value;
					var scaledValue = getValueFromCurve(value, minValue, maxValue, curveType);
					console.log(value);
					console.log(scaledValue);

					csound.SetChannel("{{ effect_name }}_{{ parameter }}", scaledValue);
					scaledValue = parseFloat(scaledValue).toFixed(2);
					$("#{{ effect_name }}_{{ parameter }}_label").text(scaledValue);

					// Check if parameter have discrete steps
					if (dataType == 'int') {
						document.getElementById("{{ effect_name }}_{{ parameter }}").step = 1;
					}
			    });
			{% endfor %}
		{% endfor %}
	}

	function mute() {
		if(!userInstanceIsPlaying) {
			csound.SetChannel("target_amplitude", 0.0);
			csound.SetChannel("user_amplitude", 1.0);
		} else {
			csound.SetChannel("target_amplitude", 1.0);
			csound.SetChannel("user_amplitude", 0.0);
		}
		userInstanceIsPlaying = !userInstanceIsPlaying;

		if(!userInstanceIsPlaying) {
			$('.knobjs-arcbg').css("stroke", "#BBB");
			$('.knobjs-arc').css("fill", "#BBB");
			$('.knob_value').css("color", "#BBB");
		} else {
			$('.knobjs-arcbg').css("stroke", "#00B2A9");
			$('.knobjs-arc').css("fill", "#00B2A9");
			$('.knob_value').css("color", "#00B2A9");
		}
	}
</script>

<input type="image" id="playPauseButton" src="{% static 'images/play.png' %}" style="outline: none;" />
<input type="button" id="switchInstanceButton" value="A/B">

<form class="test-form-wrapper" action="/tutor/test_interactive/{{ context.test_name }}/{{ context.level }}/{{ context.FX }}" method="post">
	{% csrf_token %}
	<input type="submit" value="Submit" />
</form>

<!-- csound message field -->
<div id="csound_message"> </div>

<!--pNaCl csound module -->
<div id="engine"></div>

</body>
</html>