
{% load i18n staticfiles %}

<!DOCTYPE html>
<html>
<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script src="{% static 'javascript/csound.js' %}"></script>
</head>

<body>

<script src="{% static 'javascript/interactive_csound.js' %}"></script>

<p>Test name: {{ context.test_name }}</p>
<p>FX set: {{ context.effect_set }}</p>
<p>csd file: {{ context.csd }}</p>

{% for effect_name, effect_parameter_set in context.effect_set.items %}
	{% for parameter, values in effect_parameter_set.items %}
		<p>{{ parameter }}: <input class="slider" id="{{ effect_name }}_{{ parameter }}" type="range" min={{ values.1.0 }} max={{ values.1.1 }} value="0.5" step="0.001" disabled/><label id="{{ effect_name }}_{{ parameter }}_text"></p>
	{% endfor %}
{% endfor %}

<script type="text/javascript">

    function moduleDidLoad() {
	    localStorage.clear();

	    // Load initial csd file
	    var csd_url = "/site_media/user/{{ context.csd }}";
	    var csd_name = "test.csd";

	    csound.CopyUrlToLocal(csd_url, csd_name);

	    // Load initial audio file
	    loadAudio("/site_media/system/samples/{{ context.sound }}");

	    // Start csound
	   	setTimeout(function() {
	    	csound.PlayCsd("local/test.csd");
	    }, 500);

	    // Set levels to hear only the target sound
	    csound.SetChannel("target_amplitude", 1.0);
	    csound.SetChannel("user_amplitude", 0.0);

	    // Add sliders for csound communication
		{% for effect_name, effect_parameter_set in context.effect_set.items %}
			{% for parameter, values in effect_parameter_set.items %}
			    
			    var self = this;

			    // Get max/min and the function curve type: lin, expon or log.
			    var minValue = {{ values.1.0 }};
			    var maxValue = {{ values.1.1 }};
			    var curveType = "{{ values.2 }}";

			    // Set default value. TODO: Find better solution than middle pos
			    var averageValueLinear = (minValue + maxValue) / 2;
			    document.getElementById("{{ effect_name }}_{{ parameter }}").value = getValueFromCurve(averageValueLinear, minValue, maxValue, curveType);
			    document.getElementById("{{ effect_name }}_{{ parameter }}_text").innerHTML = getValueFromCurve(averageValueLinear, minValue, maxValue, curveType);
			    csound.SetChannel("{{ effect_name }}_{{ parameter }}", getValueFromCurve(averageValueLinear, minValue, maxValue, curveType));
			    document.getElementById("{{ effect_name }}_{{ parameter }}").disabled = true;

			    // Add listeners
			    $("#{{ effect_name }}_{{ parameter }}").on("input change", function() {
			    	"use_strict";
			    	console.log("this: " + this);
			    	var value = document.getElementById("{{ effect_name }}_{{ parameter }}").value;
			    	var newVal = getValueFromCurve(value, minValue, maxValue, curveType);
			        csound.SetChannel("{{ effect_name }}_{{ parameter }}", newVal);
			    	$("#{{ effect_name }}_{{ parameter }}_text").text(newVal);
			    });
			    
			 //    document.getElementById("{{ effect_name }}_{{ parameter }}").addEventListener("input", function() {
			 //    	document.getElementById("{{ effect_name }}_{{ parameter }}_text").innerHTML = getValueFromCurve(this.value, minValue, maxValue, curveType);
				// }, false); 

			{% endfor %}
		{% endfor %}
	}

	function mute() {
	    if(!userInstanceIsPlaying) {
	        csound.SetChannel("target_amplitude", 0.0);
	        csound.SetChannel("user_amplitude", 1.0);
	    } else {
	        csound.SetChannel("target_amplitude", 1.0);
	        csound.SetChannel("user_amplitude", 0.0);
	    }
	    userInstanceIsPlaying = !userInstanceIsPlaying;
		
		// Disable if not interactable
		{% for effect_name, effect_parameter_set in context.effect_set.items %}
			{% for parameter, values in effect_parameter_set.items %}
				document.getElementById("{{ effect_name }}_{{ parameter }}").disabled = !document.getElementById("{{ effect_name }}_{{ parameter }}").disabled;
			{% endfor %}
		{% endfor %}
	}

</script>


<input type="image" id="playPauseButton" src="{% static 'images/play.png' %}" style="outline: none;" />
<input type="button" id="switchInstanceButton" value="A/B">

<audio controls>
<source src="/site_media/system/samples/{{ context.sound }}" type="audio/wav">
</audio>

  <!-- csound message field -->
<div id="csound_message"> </div>

<!--pNaCl csound module -->
<div id="engine"></div>


</body>
</html>